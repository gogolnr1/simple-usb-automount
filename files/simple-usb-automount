#!/bin/bash

set -e

mnt="/run/mount/usb"
mntopts_ntfs="user,umask=0000"
mntopts_ext4="rw"
dev="/dev/$2"

mkdir /run/mount/usb -p
findmnt /run/mount/usb || sudo mount -t tmpfs tmpfs /run/mount/usb

get_attrs () {
	for attr in TYPE LABEL
	do
		eval "MTDEV_$attr"="$(blkid -s $attr -o value /dev/$1)"
	done
}

# since eval sets global variables and we don't want them afterwards
function cleanup {
	unset MTDEV_TYPE
	unset MTDEV_LABEL
}

trap cleanup EXIT

if [[ "$1" == "a" ]]; then
	for part in $(lsblk -nro name "$dev" | tac)
	do
		get_attrs $part

		#if no filesystem matches or no label is set, do nothing
		[[ -z "$MTDEV_LABEL" ]] && continue
		[[ ! -v mntopts_$MTDEV_TYPE ]] && [[ -v mntopts_$MTDEV_FSTYPE ]] &&
			MTDEV_TYPE=$MTDEV_FSTYPE || continue

		mntopts="mntopts_$MTDEV_TYPE"

		mkdir "$mnt/$MTDEV_LABEL" -p
		mount "/dev/$part" "$mnt/$MTDEV_LABEL" -o "${!mntopts}"

		if [[ "$?" -eq 0 ]]; then
			sudo -u "$DISP_USER" DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/$DISP_UID/bus" notify-send "Mounted /dev/$part at $mnt/$MTDEV_LABEL"
		else
			rmdir "$mnt/$MTDEV_LABEL"
		fi
	done
else
	for part in $(ls "$mnt/" | grep "^$2")
	do
		get_attrs $part
		umount "$mnt/$MTDEV_LABEL"
		rmdir "$mnt/$MTDEV_LABEL"
	done
fi
